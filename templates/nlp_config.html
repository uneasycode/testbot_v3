<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NLP Configuration - Telegram Bot Manager</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; }
        .card { border-radius: 15px; box-shadow: 0 0 20px rgba(0,0,0,0.1); }
        .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none; }
        .nlp-section { margin-bottom: 2rem; }
        .key-value-pair { display: flex; align-items: center; margin-bottom: 0.5rem; }
        .key-input, .value-input { margin-right: 0.5rem; }
        .remove-btn { color: #dc3545; cursor: pointer; }
        .add-btn { background: linear-gradient(135deg, #28a745 0%, #20c997 100%); border: none; }
        .save-btn { background: linear-gradient(135deg, #fd7e14 0%, #e83e8c 100%); border: none; }
        .section-header { border-bottom: 2px solid #dee2e6; padding-bottom: 0.5rem; margin-bottom: 1rem; }
    </style>
</head>
<body>
    <div class="container-fluid py-4">
        <!-- Header -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <div class="d-flex justify-content-between align-items-center">
                            <h2 class="mb-0">
                                <i class="fas fa-brain me-2"></i>NLP Configuration
                            </h2>
                            <a href="{{ url_for('index') }}" class="btn btn-light">
                                <i class="fas fa-arrow-left me-2"></i>Back to Dashboard
                            </a>
                        </div>
                    </div>
                    <div class="card-body">
                        <p class="mb-0">
                            <i class="fas fa-info-circle text-primary me-2"></i>
                            Configure the NLP settings for your bot. These settings help the bot understand and process user messages more accurately.
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Flash Messages -->
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                <div class="row mb-4">
                    <div class="col-12">
                        {% for category, message in messages %}
                            <div class="alert alert-{{ 'success' if category == 'success' else 'danger' }} alert-dismissible fade show">
                                <i class="fas fa-{{ 'check-circle' if category == 'success' else 'exclamation-triangle' }} me-2"></i>
                                {{ message }}
                                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                            </div>
                        {% endfor %}
                    </div>
                </div>
            {% endif %}
        {% endwith %}

        <form id="nlpForm">
            <!-- NLP Enable/Disable Toggle -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card nlp-section">
                        <div class="card-header">
                            <h5 class="mb-0 section-header">
                                <i class="fas fa-toggle-on text-success me-2"></i>NLP Processing Control
                            </h5>
                            <small class="text-muted">Enable or disable NLP processing for the bot</small>
                        </div>
                        <div class="card-body">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="nlpEnabled" checked>
                                <label class="form-check-label" for="nlpEnabled">
                                    <strong>Enable NLP Processing</strong>
                                </label>
                            </div>
                            <div class="mt-3">
                                <small class="text-muted">
                                    <i class="fas fa-info-circle me-1"></i>
                                    When <strong>enabled</strong>: Bot uses NLP for fuzzy matching of user messages.<br>
                                    When <strong>disabled</strong>: Bot only responds to exact/wildcard matches in responses.json.
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Common Typos Section -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card nlp-section">
                        <div class="card-header">
                            <h5 class="mb-0 section-header">
                                <i class="fas fa-spell-check text-primary me-2"></i>Common Typos & Variations
                            </h5>
                            <small class="text-muted">Define common typos and their corrections to improve text processing</small>
                        </div>
                        <div class="card-body">
                            <div id="typosContainer">
                                <!-- Dynamic content will be loaded here -->
                            </div>
                            <button type="button" class="btn btn-success btn-sm add-btn" onclick="addTypoPair()">
                                <i class="fas fa-plus me-1"></i>Add Typo Correction
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Stop Words Section -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card nlp-section">
                        <div class="card-header">
                            <h5 class="mb-0 section-header">
                                <i class="fas fa-stop-circle text-warning me-2"></i>Stop Words
                            </h5>
                            <small class="text-muted">Words to ignore during text processing (one per line)</small>
                        </div>
                        <div class="card-body">
                            <textarea id="stopWords" name="stop_words" class="form-control" rows="8" placeholder="Enter stop words, one per line..."></textarea>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Phonetic Mappings Section -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card nlp-section">
                        <div class="card-header">
                            <h5 class="mb-0 section-header">
                                <i class="fas fa-language text-info me-2"></i>Phonetic Mappings
                            </h5>
                            <small class="text-muted">Define phonetic transformations for better Hinglish processing</small>
                        </div>
                        <div class="card-body">
                            <div id="phoneticsContainer">
                                <!-- Dynamic content will be loaded here -->
                            </div>
                            <button type="button" class="btn btn-success btn-sm add-btn" onclick="addPhoneticPair()">
                                <i class="fas fa-plus me-1"></i>Add Phonetic Mapping
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-body text-center">
                            <button type="button" class="btn btn-primary save-btn me-2" onclick="saveConfig()">
                                <i class="fas fa-save me-2"></i>Save Configuration
                            </button>
                            <button type="button" class="btn btn-secondary" onclick="loadConfig()">
                                <i class="fas fa-sync me-1"></i>Reload from File
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </form>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let nlpConfig = {};

        // Load configuration on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadConfig();
        });

        function loadConfig() {
            fetch('/api/nlp/config')
                .then(response => response.json())
                .then(data => {
                    nlpConfig = data;
                    renderConfig();
                })
                .catch(error => {
                    console.error('Error loading config:', error);
                    alert('Error loading configuration');
                });
        }

        function renderConfig() {
            // Render NLP enabled toggle
            const nlpEnabledCheckbox = document.getElementById('nlpEnabled');
            nlpEnabledCheckbox.checked = nlpConfig.nlp_enabled !== false; // Default to true

            // Render typos
            const typosContainer = document.getElementById('typosContainer');
            typosContainer.innerHTML = '';

            if (nlpConfig.common_typos) {
                Object.entries(nlpConfig.common_typos).forEach(([key, value]) => {
                    addTypoPair(key, value);
                });
            }

            // Render stop words
            const stopWordsTextarea = document.getElementById('stopWords');
            if (nlpConfig.stop_words) {
                stopWordsTextarea.value = nlpConfig.stop_words.join('\n');
            }

            // Render phonetics
            const phoneticsContainer = document.getElementById('phoneticsContainer');
            phoneticsContainer.innerHTML = '';

            if (nlpConfig.phonetic_mappings) {
                Object.entries(nlpConfig.phonetic_mappings).forEach(([key, value]) => {
                    addPhoneticPair(key, value);
                });
            }
        }

        function addTypoPair(key = '', value = '') {
            const container = document.getElementById('typosContainer');
            const div = document.createElement('div');
            div.className = 'key-value-pair';
            div.innerHTML = `
                <input type="text" class="form-control key-input" style="width: 200px;" placeholder="Typo" value="${key}">
                <span class="text-muted mx-2">→</span>
                <input type="text" class="form-control value-input" style="width: 200px;" placeholder="Correction" value="${value}">
                <i class="fas fa-times remove-btn ms-2" onclick="removePair(this)"></i>
            `;
            container.appendChild(div);
        }

        function addPhoneticPair(key = '', value = '') {
            const container = document.getElementById('phoneticsContainer');
            const div = document.createElement('div');
            div.className = 'key-value-pair';
            div.innerHTML = `
                <input type="text" class="form-control key-input" style="width: 150px;" placeholder="From" value="${key}" maxlength="5">
                <span class="text-muted mx-2">→</span>
                <input type="text" class="form-control value-input" style="width: 150px;" placeholder="To" value="${value}" maxlength="5">
                <i class="fas fa-times remove-btn ms-2" onclick="removePair(this)"></i>
            `;
            container.appendChild(div);
        }

        function removePair(element) {
            element.parentElement.remove();
        }

        function saveConfig() {
            // Collect NLP enabled setting
            const nlpEnabled = document.getElementById('nlpEnabled').checked;

            // Collect typos
            const typoPairs = document.querySelectorAll('#typosContainer .key-value-pair');
            const commonTypos = {};
            typoPairs.forEach(pair => {
                const key = pair.querySelector('.key-input').value.trim();
                const value = pair.querySelector('.value-input').value.trim();
                if (key && value) {
                    commonTypos[key] = value;
                }
            });

            // Collect stop words
            const stopWordsText = document.getElementById('stopWords').value;
            const stopWords = stopWordsText.split('\n').map(word => word.trim()).filter(word => word);

            // Collect phonetics
            const phoneticPairs = document.querySelectorAll('#phoneticsContainer .key-value-pair');
            const phoneticMappings = {};
            phoneticPairs.forEach(pair => {
                const key = pair.querySelector('.key-input').value.trim();
                const value = pair.querySelector('.value-input').value.trim();
                if (key && value) {
                    phoneticMappings[key] = value;
                }
            });

            const configData = {
                nlp_enabled: nlpEnabled,
                common_typos: commonTypos,
                stop_words: stopWords,
                phonetic_mappings: phoneticMappings
            };

            fetch('/api/nlp/config', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(configData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Configuration saved successfully!');
                } else {
                    alert('Error saving configuration: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error saving configuration');
            });
        }
    </script>
</body>
</html>
