<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Review Learned Responses - Telegram Bot Manager</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; }
        .card { border-radius: 15px; box-shadow: 0 0 20px rgba(0,0,0,0.1); }
        .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none; }
        .response-item { border: 1px solid #dee2e6; border-radius: 10px; margin-bottom: 1rem; padding: 1rem; }
        .response-item.selected { border-color: #28a745; background-color: #f8fff8; }
        .response-item.rejected { border-color: #dc3545; background-color: #fff8f8; opacity: 0.6; }
        .confidence-badge { font-size: 0.75rem; }
        .source-badge { font-size: 0.7rem; }
        .response-preview { background-color: #f8f9fa; padding: 0.5rem; border-radius: 5px; margin: 0.5rem 0; }
        .stats-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .checkbox-lg { transform: scale(1.2); }
        .action-buttons { position: sticky; top: 20px; }
    </style>
</head>
<body>
    <div class="container-fluid py-4">
        <!-- Header -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <div class="d-flex justify-content-between align-items-center">
                            <h2 class="mb-0">
                                <i class="fas fa-check-circle me-2"></i>Review Learned Responses
                            </h2>
                            <a href="{{ url_for('index') }}" class="btn btn-light">
                                <i class="fas fa-arrow-left me-2"></i>Back to Dashboard
                            </a>
                        </div>
                    </div>
                    <div class="card-body">
                        <p class="mb-0">
                            <i class="fas fa-info-circle text-primary me-2"></i>
                            Review the responses learned from conversations. Select the ones you want to add to your bot's final response database.
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Statistics Cards -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card stats-card text-white">
                    <div class="card-body text-center">
                        <i class="fas fa-brain fa-2x mb-2"></i>
                        <h4 id="totalLearned">-</h4>
                        <p class="mb-0">Total Learned</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stats-card text-white">
                    <div class="card-body text-center">
                        <i class="fas fa-check-circle fa-2x mb-2"></i>
                        <h4 id="selectedCount">0</h4>
                        <p class="mb-0">Selected</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stats-card text-white">
                    <div class="card-body text-center">
                        <i class="fas fa-times-circle fa-2x mb-2"></i>
                        <h4 id="rejectedCount">0</h4>
                        <p class="mb-0">Rejected</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stats-card text-white">
                    <div class="card-body text-center">
                        <i class="fas fa-clock fa-2x mb-2"></i>
                        <h4 id="pendingCount">-</h4>
                        <p class="mb-0">Pending Review</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- Main Content -->
            <div class="col-md-8">
                <!-- Filters and Search -->
                <div class="card mb-4">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <input type="text" id="searchInput" class="form-control" placeholder="Search responses...">
                            </div>
                            <div class="col-md-6">
                                <select id="filterSelect" class="form-select">
                                    <option value="all">All Responses</option>
                                    <option value="high_confidence">High Confidence (>80%)</option>
                                    <option value="learned">Learned from Conversations</option>
                                    <option value="unanswered">Unanswered Suggestions</option>
                                    <option value="selected">Selected</option>
                                    <option value="rejected">Rejected</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Responses List -->
                <div id="responsesContainer">
                    <div class="text-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">Loading learned responses...</p>
                    </div>
                </div>

                <!-- Load More Button -->
                <div class="text-center mt-4" id="loadMoreContainer" style="display: none;">
                    <button class="btn btn-outline-primary" onclick="loadMoreResponses()">
                        <i class="fas fa-plus me-1"></i>Load More Responses
                    </button>
                </div>
            </div>

            <!-- Sidebar with Actions -->
            <div class="col-md-4">
                <div class="action-buttons">
                    <!-- Bulk Actions -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h6 class="mb-0">
                                <i class="fas fa-tasks me-2"></i>Bulk Actions
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="d-grid gap-2">
                                <button class="btn btn-success" onclick="selectAllVisible()">
                                    <i class="fas fa-check-square me-1"></i>Select All Visible
                                </button>
                                <button class="btn btn-warning" onclick="selectHighConfidence()">
                                    <i class="fas fa-star me-1"></i>Select High Confidence
                                </button>
                                <button class="btn btn-danger" onclick="rejectAllVisible()">
                                    <i class="fas fa-times-circle me-1"></i>Reject All Visible
                                </button>
                                <button class="btn btn-secondary" onclick="clearSelection()">
                                    <i class="fas fa-undo me-1"></i>Clear Selection
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Add to Final Responses -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h6 class="mb-0">
                                <i class="fas fa-plus-circle me-2"></i>Add to Bot
                            </h6>
                        </div>
                        <div class="card-body">
                            <p class="small text-muted mb-3">Add selected responses to your bot's final response database.</p>
                            <div class="d-grid">
                                <button class="btn btn-primary btn-lg" id="addToBotBtn" onclick="addSelectedToBot()" disabled>
                                    <i class="fas fa-robot me-2"></i>Add Selected to Bot
                                    <span class="badge bg-light text-dark ms-2" id="selectedBadge">0</span>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Quick Stats -->
                    <div class="card">
                        <div class="card-header">
                            <h6 class="mb-0">
                                <i class="fas fa-chart-bar me-2"></i>Quick Stats
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="row text-center">
                                <div class="col-6">
                                    <div class="border-end">
                                        <div class="h5 mb-0" id="approvedPercent">-</div>
                                        <small class="text-muted">Approved</small>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="h5 mb-0" id="rejectedPercent">-</div>
                                    <small class="text-muted">Rejected</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Success Modal -->
    <div class="modal fade" id="successModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-check-circle text-success me-2"></i>Success!
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p id="successMessage"></p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Continue Reviewing</button>
                    <a href="{{ url_for('index') }}" class="btn btn-secondary">Back to Dashboard</a>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let allResponses = [];
        let filteredResponses = [];
        let currentPage = 0;
        const pageSize = 20;
        let selectedResponses = new Set();
        let rejectedResponses = new Set();

        // Load data on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadLearnedResponses();
            setupFilters();
        });

        function setupFilters() {
            document.getElementById('searchInput').addEventListener('input', applyFilters);
            document.getElementById('filterSelect').addEventListener('change', applyFilters);
        }

        function loadLearnedResponses() {
            fetch('/api/responses/learned')
                .then(response => response.json())
                .then(data => {
                    if (data.responses) {
                        allResponses = Object.entries(data.responses).map(([keyword, response]) => ({
                            keyword,
                            ...response
                        }));
                        updateStats();
                        applyFilters();
                    } else {
                        document.getElementById('responsesContainer').innerHTML =
                            '<div class="alert alert-info"><i class="fas fa-info-circle me-2"></i>No learned responses found. Try running the learning process first.</div>';
                    }
                })
                .catch(error => {
                    console.error('Error loading responses:', error);
                    document.getElementById('responsesContainer').innerHTML =
                        '<div class="alert alert-danger"><i class="fas fa-exclamation-triangle me-2"></i>Error loading learned responses.</div>';
                });
        }

        function updateStats() {
            document.getElementById('totalLearned').textContent = allResponses.length;
            document.getElementById('pendingCount').textContent = allResponses.length - selectedResponses.size - rejectedResponses.size;

            const approvedPercent = allResponses.length > 0 ? Math.round((selectedResponses.size / allResponses.length) * 100) : 0;
            const rejectedPercent = allResponses.length > 0 ? Math.round((rejectedResponses.size / allResponses.length) * 100) : 0;

            document.getElementById('approvedPercent').textContent = approvedPercent + '%';
            document.getElementById('rejectedPercent').textContent = rejectedPercent + '%';
        }

        function applyFilters() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const filterType = document.getElementById('filterSelect').value;

            filteredResponses = allResponses.filter(response => {
                // Search filter
                const matchesSearch = !searchTerm ||
                    response.keyword.toLowerCase().includes(searchTerm) ||
                    (response.content && response.content.join(' ').toLowerCase().includes(searchTerm));

                // Type filter
                let matchesFilter = true;
                switch (filterType) {
                    case 'high_confidence':
                        matchesFilter = (response.confidence || 0) > 80;
                        break;
                    case 'learned':
                        matchesFilter = response.source === 'learned';
                        break;
                    case 'unanswered':
                        matchesFilter = response.source === 'unanswered_suggestion';
                        break;
                    case 'selected':
                        matchesFilter = selectedResponses.has(response.keyword);
                        break;
                    case 'rejected':
                        matchesFilter = rejectedResponses.has(response.keyword);
                        break;
                }

                return matchesSearch && matchesFilter;
            });

            currentPage = 0;
            renderResponses();
        }

        function renderResponses() {
            const container = document.getElementById('responsesContainer');
            const startIndex = currentPage * pageSize;
            const endIndex = startIndex + pageSize;
            const responsesToShow = filteredResponses.slice(startIndex, endIndex);

            if (responsesToShow.length === 0 && currentPage === 0) {
                container.innerHTML = '<div class="alert alert-info"><i class="fas fa-info-circle me-2"></i>No responses match your filters.</div>';
                document.getElementById('loadMoreContainer').style.display = 'none';
                return;
            }

            let html = '';
            responsesToShow.forEach(response => {
                const isSelected = selectedResponses.has(response.keyword);
                const isRejected = rejectedResponses.has(response.keyword);
                const confidence = response.confidence || 0;
                const source = response.source || 'unknown';

                let statusClass = '';
                let statusIcon = '';
                if (isSelected) {
                    statusClass = 'selected';
                    statusIcon = '<i class="fas fa-check-circle text-success me-1"></i>';
                } else if (isRejected) {
                    statusClass = 'rejected';
                    statusIcon = '<i class="fas fa-times-circle text-danger me-1"></i>';
                }

                html += `
                    <div class="response-item ${statusClass}" id="response-${response.keyword.replace(/[^a-zA-Z0-9]/g, '_')}">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <div class="flex-grow-1">
                                <h6 class="mb-1">
                                    ${statusIcon}
                                    <code>${response.keyword}</code>
                                </h6>
                                <div class="d-flex gap-2 mb-2">
                                    <span class="badge bg-primary confidence-badge">
                                        <i class="fas fa-chart-line me-1"></i>${confidence}% confidence
                                    </span>
                                    <span class="badge bg-secondary source-badge">
                                        <i class="fas fa-tag me-1"></i>${source.replace('_', ' ')}
                                    </span>
                                </div>
                            </div>
                            <div class="d-flex gap-1">
                                <button class="btn btn-sm btn-success" onclick="selectResponse('${response.keyword}')" ${isSelected ? 'disabled' : ''}>
                                    <i class="fas fa-check"></i>
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="rejectResponse('${response.keyword}')" ${isRejected ? 'disabled' : ''}>
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                        <div class="response-preview">
                            <strong>Response:</strong>
                            ${Array.isArray(response.content) ? response.content.join(', ') : response.content}
                        </div>
                        ${response.similar_inputs ? `
                            <small class="text-muted">
                                <i class="fas fa-link me-1"></i>Similar inputs: ${response.similar_inputs.join(', ')}
                            </small>
                        ` : ''}
                    </div>
                `;
            });

            if (currentPage === 0) {
                container.innerHTML = html;
            } else {
                container.innerHTML += html;
            }

            // Show/hide load more button
            document.getElementById('loadMoreContainer').style.display =
                endIndex < filteredResponses.length ? 'block' : 'none';
        }

        function loadMoreResponses() {
            currentPage++;
            renderResponses();
        }

        function selectResponse(keyword) {
            selectedResponses.add(keyword);
            rejectedResponses.delete(keyword);
            updateUI();
        }

        function rejectResponse(keyword) {
            rejectedResponses.add(keyword);
            selectedResponses.delete(keyword);
            updateUI();
        }

        function selectAllVisible() {
            const visibleItems = document.querySelectorAll('#responsesContainer .response-item:not(.selected):not(.rejected)');
            visibleItems.forEach(item => {
                const keyword = item.id.replace('response-', '').replace(/_/g, '');
                selectedResponses.add(keyword);
                rejectedResponses.delete(keyword);
            });
            updateUI();
        }

        function selectHighConfidence() {
            filteredResponses.forEach(response => {
                if ((response.confidence || 0) > 80) {
                    selectedResponses.add(response.keyword);
                    rejectedResponses.delete(response.keyword);
                }
            });
            updateUI();
        }

        function rejectAllVisible() {
            const visibleItems = document.querySelectorAll('#responsesContainer .response-item:not(.selected):not(.rejected)');
            visibleItems.forEach(item => {
                const keyword = item.id.replace('response-', '').replace(/_/g, '');
                rejectedResponses.add(keyword);
                selectedResponses.delete(keyword);
            });
            updateUI();
        }

        function clearSelection() {
            selectedResponses.clear();
            rejectedResponses.clear();
            updateUI();
        }

        function updateUI() {
            document.getElementById('selectedCount').textContent = selectedResponses.size;
            document.getElementById('rejectedCount').textContent = rejectedResponses.size;
            document.getElementById('selectedBadge').textContent = selectedResponses.size;
            document.getElementById('addToBotBtn').disabled = selectedResponses.size === 0;

            updateStats();
            renderResponses();
        }

        function addSelectedToBot() {
            if (selectedResponses.size === 0) return;

            const selectedArray = Array.from(selectedResponses);
            document.getElementById('addToBotBtn').disabled = true;
            document.getElementById('addToBotBtn').innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Adding...';

            fetch('/api/responses/add-selected', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ keywords: selectedArray })
            })
            .then(response => response.json())
            .then(data => {
                document.getElementById('addToBotBtn').disabled = false;
                document.getElementById('addToBotBtn').innerHTML = '<i class="fas fa-robot me-2"></i>Add Selected to Bot';

                if (data.success) {
                    document.getElementById('successMessage').textContent =
                        `Successfully added ${data.added_count} responses to your bot!`;
                    const successModal = new bootstrap.Modal(document.getElementById('successModal'));
                    successModal.show();

                    // Remove added responses from current view
                    selectedArray.forEach(keyword => {
                        selectedResponses.delete(keyword);
                    });
                    updateUI();
                } else {
                    alert('Error adding responses: ' + (data.error || 'Unknown error'));
                }
            })
            .catch(error => {
                console.error('Error:', error);
                document.getElementById('addToBotBtn').disabled = false;
                document.getElementById('addToBotBtn').innerHTML = '<i class="fas fa-robot me-2"></i>Add Selected to Bot';
                alert('Error adding responses to bot');
            });
        }
    </script>
</body>
</html>
